language: generic
sudo: false
env:
  global:
    - INSTALL_EDM_VERSION=1.9.2
      PYTHONUNBUFFERED="1"


matrix:
  include:
    - env: ENAML='0.9.8'  SOURCE='edm'  # The earliest version on EDS for rh6
    - env: ENAML='0.8.9'  SOURCE='pypi' # The earliest supported
    - env: ENAML='latest' SOURCE='edm'
    - env: ENAML='latest' SOURCE='pypi'
    - if: type = cron
      env: ENAML='latest' SOURCE='github'
  allow_failures:
    - env: ENAML='latest' SOURCE='pypi'
    - env: ENAML='latest' SOURCE='github'

addons:
  apt:
    packages:
    - swig
    - ccache
cache:
  pip: true
  directories:
    - $HOME/.ccache
    - $HOME/.cache/edm
    - $HOME/.edm/pkgs
    - $HOME/.edm/pkg

before_install:
  - mkdir -p "${HOME}/.cache/download"
  - export PATH="/usr/lib/ccache/usr/local/bin:${HOME}/edm/bin:${PATH}"
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - ccache -s
install:
  - ./install-edm-linux.sh
  - edm install -y click
  - edm run -- python -m etstools install --enaml=${ENAML} --source=${SOURCE}
script:
  - edm run -- python -m etstools test
after_success:
  - edm run -- pip install codecov
  - edm run -- codecov